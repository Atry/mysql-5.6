include/rpl_init.inc [topology=none]
include/rpl_default_connections.inc
# Initialize the database on source server that will be dumped and populate some records.
create database db1;
use db1;
create table t1 (
`id` int not null auto_increment,
`k` int,
`data` varchar(2048),
primary key (`id`),
key (`k`)
) engine=rocksdb;
insert into t1(k, data) values (999, 'hello');
insert into t1(k, data) values (1000, 'world');
# Test that dumping innodb table will not dump internal id
create table t1_innodb (
`id` int not null auto_increment,
`k` int,
`data` varchar(2048),
primary key (`id`),
key (`k`)
) engine=innodb;
select * from information_schema.rocksdb_ddl where table_schema = 'db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	1	1	15	0	0	default	3	2809014792
db1	t1	NULL	k	0	2	2	16	0	0	default	3	2809014792
BEGIN;
SELECT hex(id) FROM db1.t1 FOR UPDATE;
hex(id)
1
2
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000001
a76e2a08	00000001
ROLLBACK;
Dump with rocksdb_dump_internal_id
call mtr.add_suppression("RocksDB: Conflict when changing index_number.*");
call mtr.add_suppression("RocksDB: rocksdb_alter_cur_db_num database is not empty.*");
create database db1;
create database db2;
# Create table T2 on server 2 that will have same index number as T1 on server 1.
create table db1.t2 (
a int primary key
) engine=rocksdb;
# Create table T3 on server 2 that will have 1 index number same as T1 on server 1.
create table db1.t3 (
a int primary key,
b int,
key(b)
) engine=rocksdb;
# Recreate table T4 on server 2 that will have no index number same as T1 on server 1.
create table db1.t4 (
a int primary key,
b int,
key(b)
) engine=rocksdb;
select * from information_schema.rocksdb_ddl;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
db1	t2	NULL	PRIMARY	0	1	1	15	0	0	default	NULL	2809014792
db1	t3	NULL	PRIMARY	0	2	1	15	0	0	default	NULL	2809014792
db1	t3	NULL	b	0	3	2	16	0	0	default	NULL	2809014792
# replaying mysqldump will fail because of conflicting index number in db1.t2
drop table db1.t2;
select * from information_schema.rocksdb_ddl;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	6	1	15	0	0	default	3	2809014792
db1	t1	NULL	k	0	7	2	16	0	0	default	3	2809014792
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
db1	t3	NULL	PRIMARY	0	2	1	15	0	0	default	NULL	2809014792
db1	t3	NULL	b	0	3	2	16	0	0	default	NULL	2809014792
# replaying mysqldump will fail because of conflicting index number in db1.t3
# renameing t3 to different database will still keep the same index numbers.
rename table db1.t3 to db2.t3;
select * from information_schema.rocksdb_ddl;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db2	t3	NULL	PRIMARY	0	2	1	15	0	0	default	NULL	2809014792
db2	t3	NULL	b	0	3	2	16	0	0	default	NULL	2809014792
db1	t1	NULL	PRIMARY	0	8	1	15	0	0	default	3	2809014792
db1	t1	NULL	k	0	9	2	16	0	0	default	3	2809014792
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
# replaying mysqldump will fail because of conflicting index number in db2.t3
drop table db2.t3;
# Enter data in db1.t4 and verify that the replay of mysqldump fails 
insert into db1.t4 values(1,2);
select * from information_schema.rocksdb_ddl;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	10	1	15	0	0	default	3	2809014792
db1	t1	NULL	k	0	11	2	16	0	0	default	3	2809014792
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
# Clear all the data in db1 and verify that mysqldump replay will succeed.
delete from db1.t4;
select * from information_schema.rocksdb_ddl;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	10	1	15	0	0	default	3	2809014792
db1	t1	NULL	k	0	11	2	16	0	0	default	3	2809014792
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
select * from information_schema.rocksdb_ddl where table_schema = 'db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	1	1	15	0	0	default	3	2809014792
db1	t1	NULL	k	0	2	2	16	0	0	default	3	2809014792
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
BEGIN;
SELECT hex(id) FROM db1.t1 FOR UPDATE;
hex(id)
1
2
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000001
a76e2a08	00000001
ROLLBACK;
insert into db1.t1(k, data) values (1001, '!!!!!');
select * from db1.t1;
id	k	data
1	999	hello
2	1000	world
3	1001	!!!!!
select * from information_schema.rocksdb_ddl where table_schema = 'db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	1	1	15	0	0	default	4	2809014792
db1	t1	NULL	k	0	2	2	16	0	0	default	4	2809014792
db1	t4	NULL	PRIMARY	0	4	1	15	0	0	default	NULL	2809014792
db1	t4	NULL	b	0	5	2	16	0	0	default	NULL	2809014792
BEGIN;
SELECT hex(id) FROM db1.t1 FOR UPDATE;
hex(id)
1
2
3
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000001
a76e2a08	00000001
a76e2a08	00000001
ROLLBACK;
drop database db1;
drop database db1;
drop database db2;
include/rpl_end.inc
