include/master-slave.inc
Warnings:
Note	####	Sending passwords in plain text without SSL/TLS is extremely insecure.
Note	####	Storing MySQL user name or password information in the master info repository is not secure and is therefore not recommended. Please consider using the USER and PASSWORD connection options for START SLAVE; see the 'START SLAVE Syntax' in the MySQL Manual for more information.
[connection master]
################################################
# Test db and index number assignment
################################################
create database db1;
use db1;
create table t1(a int primary key, b int, key(b));
create database db2;
use db2;
create table t1(a int primary key, b int, key(b));
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	256	1	15	0	0	default	NULL	2809014792
db1	t1	NULL	b	0	257	2	16	0	0	default	NULL	2809014792
db2	t1	NULL	PRIMARY	0	258	1	15	0	0	default	NULL	2454721479
db2	t1	NULL	b	0	259	2	16	0	0	default	NULL	2454721479
drop database db1;
drop database db2;
################################################
# Recreate the database with the same name
################################################
create database db1;
use db1;
create table t1(a int primary key, b int, key(b));
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	260	1	15	0	0	default	NULL	2809014792
db1	t1	NULL	b	0	261	2	16	0	0	default	NULL	2809014792
drop database db1;
################################################
# Verify the key composition of the row 
################################################
create database db1;
use db1;
create table t1(a int primary key);
insert into t1 values(999);
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000106
ROLLBACK;
drop database db1;
####################################################
# Verify database entry is preserved across restart 
####################################################
create database db1;
use db1;
create table t1(a int primary key);
insert into t1 values(999);
BEGIN;
SELECT * from t1;
a
999
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000107
ROLLBACK;
select * from information_schema.rocksdb_ddl where table_schema='db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	263	1	15	0	0	default	NULL	2809014792
include/rpl_restart_server.inc [server_number=1]
include/rpl_restart_server.inc [server_number=2]
include/start_slave.inc
select * from information_schema.rocksdb_ddl where table_schema='db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL		0	263	1	15	0	0	default	NULL	2809014792
BEGIN;
SELECT * from t1;
a
999
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000107
ROLLBACK;
drop database db1;
################################################
# Verify drop database drops the table 
################################################
create database db1;
use db1;
create table t1(a int primary key);
insert into t1 values(999);
BEGIN;
SELECT * from t1;
a
999
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000108
ROLLBACK;
select * from information_schema.rocksdb_ddl where table_schema='db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	264	1	15	0	0	default	NULL	2809014792
drop database db1;
select * from information_schema.rocksdb_ddl where table_schema='db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
SELECT * from db1.t1;
ERROR 42000: Unknown database 'db1'
include/rpl_restart_server.inc [server_number=1]
include/rpl_restart_server.inc [server_number=2]
include/start_slave.inc
SELECT * from db1.t1;
ERROR 42000: Unknown database 'db1'
select * from information_schema.rocksdb_ddl where table_schema='db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
create database db1;
use db1;
create table t1(a int primary key);
insert into t1 values(1000);
select * from information_schema.rocksdb_ddl where table_schema='db1';
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	265	1	15	0	0	default	NULL	2809014792
BEGIN;
SELECT * from t1;
a
1000
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E8
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	00000109
ROLLBACK;
drop database db1;
################################################
# Test db prefix content on secondary
################################################
create database db1;
use db1;
create table t1(a int primary key);
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	266	1	15	0	0	default	NULL	2809014792
include/sync_slave_sql_with_master.inc
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	266	1	15	0	0	default	NULL	2809014792
drop database db1;
################################################
# Test db rename scenario
################################################
create database db1;
create database db2;
use db1;
create table t1(a int primary key);
insert into t1 values(999);
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	0000010b
ROLLBACK;
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	267	1	15	0	0	default	NULL	2809014792
rename table db1.t1 to db2.t1;
use db2;
create table t2(a int primary key);
insert into t2 values(999);
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db2	t1	NULL	PRIMARY	0	267	1	15	0	0	default	NULL	2809014792
select * from information_schema.rocksdb_ddl where table_schema='db2' order by table_name;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db2	t1	NULL	PRIMARY	0	267	1	15	0	0	default	NULL	2809014792
db2	t2	NULL	PRIMARY	0	268	1	15	0	0	default	NULL	2454721479
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT hex(a) FROM t2 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
925013c7	0000010c
a76e2a08	0000010b
ROLLBACK;
insert into t1 values(1000);
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
3E8
SELECT hex(a) FROM t2 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
925013c7	0000010c
a76e2a08	0000010b
a76e2a08	0000010b
ROLLBACK;
drop database db1;
drop database db2;
################################################
# Test db rename scenario on secondaries
################################################
create database db1;
create database db2;
use db1;
create table t1(a int primary key);
insert into t1 values(999);
include/sync_slave_sql_with_master.inc
use db1;
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
a76e2a08	0000010d
ROLLBACK;
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db1	t1	NULL	PRIMARY	0	269	1	15	0	0	default	NULL	2809014792
rename table db1.t1 to db2.t1;
use db2;
create table t2(a int primary key);
insert into t2 values(999);
include/sync_slave_sql_with_master.inc
select * from information_schema.rocksdb_ddl where table_name='t1' order by table_schema;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db2	t1	NULL	PRIMARY	0	269	1	15	0	0	default	NULL	2809014792
select * from information_schema.rocksdb_ddl where table_schema='db2' order by table_name;
TABLE_SCHEMA	TABLE_NAME	PARTITION_NAME	INDEX_NAME	COLUMN_FAMILY	INDEX_NUMBER	INDEX_TYPE	KV_FORMAT_VERSION	TTL_DURATION	INDEX_FLAGS	CF	AUTO_INCREMENT	DB_NUMBER
db2	t1	NULL	PRIMARY	0	269	1	15	0	0	default	NULL	2809014792
db2	t2	NULL	PRIMARY	0	270	1	15	0	0	default	NULL	2454721479
use db2;
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
SELECT hex(a) FROM t2 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
925013c7	0000010e
a76e2a08	0000010d
ROLLBACK;
insert into t1 values(1000);
BEGIN;
SELECT hex(a) FROM t1 FOR UPDATE;
hex(a)
3E7
3E8
SELECT hex(a) FROM t2 FOR UPDATE;
hex(a)
3E7
SELECT SUBSTRING(a.key,1,8), SUBSTRING(a.key,9,8) FROM information_schema.rocksdb_locks AS a ORDER BY a.key;
SUBSTRING(a.key,1,8)	SUBSTRING(a.key,9,8)
925013c7	0000010e
a76e2a08	0000010d
a76e2a08	0000010d
ROLLBACK;
drop database db1;
drop database db2;
################################################
# Cleanup
################################################
include/rpl_end.inc
