set global sql_stats_control = ON;
use information_schema;
#
# Verify with nothing
#
select 1;
1
1
select * from sql_text;
SQL_ID	SQL_TYPE	SQL_TEXT_LENGTH	SQL_TEXT
db1589f429c8f6fbba750f47fbc7c130	SELECT	9	SELECT ? 
683829d6a97b6f4aaaf243155e5f66e7	USE	25	USE `information_schema` 
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
#
# Verify with async id
#
/* async-12345 */ select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
#
# Verify with query attrs = qa_test1
#   original_caller QA = oc_qa_test1 (not allowed yet)
#
select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
#
# Verify with query attrs = qa_test1
#   original_caller QA = oc_qa_test1 (allowed)
#
set global original_caller_in_client_attributes=on;
select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
#
# Verify with query attrs = qa_test1 and async id
#   original_caller QA = oc_qa_test1
#
/* async-12345 */ select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
#
# Verify with query attrs = qa_test1 and async id using query attrs
#   original_caller QA = oc_qa_test1
#
select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
#
# Verify with query attrs = qa_test1 and async id using query attrs (and query comments)
#   original_caller QA = oc_qa_test1
#
/* async-12345 */ select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
create user user@localhost identified by 'su';
grant all on *.* to user@localhost with grant option;
use information_schema;
#
# Verify with just conn attrs = ca_test2 and original_caller CA = oc_ca_test2
#
select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
#
# Verify with conn attrs = ca_test2 and async id
#  original_caller CA = oc_ca_test2
#
/* async-12345 */ select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
#
# Verify with just conn attrs = ca_test2 and query attrs = qa_test3
#  original_caller CA = oc_ca_test2 and original_caller QA = oc_qa_test3
#
select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
dae96c1c6f278f6bb917953f184a5f1b	information_schema	user	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test3', 'caller' : 'qa_test3', 'async_id' : '56789'}
#
# Verify with just conn attrs = ca_test2 and query attrs = qa_test3 and async id
#  original_caller CA = oc_ca_test2 and original_caller QA = oc_qa_test3
#
/* async-12345 */ select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
dae96c1c6f278f6bb917953f184a5f1b	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test3', 'caller' : 'qa_test3', 'async_id' : '56789'}
#
# Verify with just conn attrs = ca_test2 and original_caller CA = oc_ca_test2 again
#
select 1;
1
1
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
01cbb601901347627cf6789bdc8de2e6	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1'}
28b1c55c76dad7360f14f3d9f1823864	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'caller' : 'qa_test1'}
6b4210c41003cbfa6be78f0c1e83aee2	information_schema	root	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '56789'}
8ea1073e1f5fca20c6f0621cda79a968	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test1', 'caller' : 'qa_test1', 'async_id' : '12345'}
92c0acc6261bcb114a857e42acb41812	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{'async_id' : '12345'}
99914b932bd37a50b983c5e7c90ae93b	information_schema	root	1	db1589f429c8f6fbba750f47fbc7c130	{}
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	3	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
dae96c1c6f278f6bb917953f184a5f1b	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test3', 'caller' : 'qa_test3', 'async_id' : '56789'}
set global sql_stats_control = OFF_HARD;
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
set global sql_stats_control = ON;
#
# Test multiquery cases
#
/* async-12345 */ select 1; select 2;
||||
1
1
2
2
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
/* async-12345 */ select 1; select 2;
||||
1
1
2
2
select stats.client_id, table_schema, user_name, execution_count, sql_id, client_attributes
from sql_statistics stats, client_attributes ca
where stats.client_id = ca.client_id
and sql_id = "db1589f429c8f6fbba750f47fbc7c130"
order by client_id;
client_id	table_schema	user_name	execution_count	sql_id	client_attributes
bbe286d6f2ed0c7dacd20e9a07a52060	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_ca_test2', 'caller' : 'ca_test2', 'async_id' : '56789'}
dae96c1c6f278f6bb917953f184a5f1b	information_schema	user	2	db1589f429c8f6fbba750f47fbc7c130	{'original_caller' : 'oc_qa_test3', 'caller' : 'qa_test3', 'async_id' : '56789'}
set global original_caller_in_client_attributes=off;
set global sql_stats_control = DEFAULT;
drop user user@localhost;
